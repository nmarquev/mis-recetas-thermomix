<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Instalar Bookmarklet - Thermomix Recipe Genius</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            background: #f8f9fa;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .emoji {
            font-size: 2em;
            margin-right: 10px;
        }

        .bookmarklet-container {
            background: #e8f4fd;
            border: 2px dashed #3498db;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .bookmarklet-link {
            display: inline-block;
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            text-decoration: none;
            font-weight: bold;
            font-size: 16px;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .bookmarklet-link:hover {
            background: #45a049;
            text-decoration: none;
            color: white;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }

        .step {
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-left: 4px solid #4CAF50;
            border-radius: 4px;
        }

        .step strong {
            color: #2c3e50;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .feature {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }

        .feature h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .warning {
            background: #ffebee;
            border: 1px solid #ffcdd2;
            border-radius: 8px;
            padding: 15px;
            color: #c62828;
            margin: 20px 0;
        }

        .code {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            margin: 10px 0;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>
            <span class="emoji">üç≥</span>
            Thermomix Recipe Genius - Bookmarklet
        </h1>

        <p style="text-align: center; font-size: 18px; color: #666;">
            Captura recetas de <strong>cualquier p√°gina web</strong> (incluyendo Cookidoo) directamente a tu app Recipe Genius
        </p>

        <div class="bookmarklet-container">
            <h2>üìå Arrastra este bot√≥n a tu barra de marcadores:</h2>
            <a href="javascript:(function(){'use strict';const API_BASE='http://localhost:3003';const API_ENDPOINT=`${API_BASE}/api/import-html`;const overlayStyles=`#recipe-importer-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);z-index:999999;display:flex;justify-content:center;align-items:center;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}#recipe-importer-modal{background:white;border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;box-shadow:0 10px 30px rgba(0,0,0,0.3);position:relative}#recipe-importer-close{position:absolute;top:12px;right:16px;background:none;border:none;font-size:24px;cursor:pointer;color:#666;padding:4px 8px}#recipe-importer-close:hover{color:#000}.recipe-importer-title{color:#2c3e50;margin:0 0 16px 0;font-size:20px;font-weight:600}.recipe-importer-status{padding:12px;border-radius:6px;margin:16px 0;font-weight:500}.status-loading{background:#e3f2fd;color:#1976d2;border:1px solid #bbdefb}.status-success{background:#e8f5e8;color:#2e7d32;border:1px solid #a5d6a7}.status-error{background:#ffebee;color:#c62828;border:1px solid #ffcdd2}.recipe-preview{border:1px solid #e0e0e0;border-radius:8px;padding:16px;margin:16px 0;background:#f9f9f9}.recipe-preview h3{margin:0 0 8px 0;color:#2c3e50;font-size:18px}.recipe-preview p{margin:4px 0;color:#666;font-size:14px}.recipe-importer-buttons{display:flex;gap:12px;margin-top:20px}.btn{padding:10px 20px;border:none;border-radius:6px;cursor:pointer;font-weight:500;font-size:14px;transition:background-color 0.2s}.btn-primary{background:#4CAF50;color:white}.btn-primary:hover{background:#45a049}.btn-secondary{background:#f5f5f5;color:#666;border:1px solid #ddd}.btn-secondary:hover{background:#eeeeee}.loading-spinner{display:inline-block;width:20px;height:20px;border:3px solid #f3f3f3;border-top:3px solid #3498db;border-radius:50%;animation:spin 1s linear infinite;margin-right:8px}@keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}`;function getAuthToken(){try{const token=localStorage.getItem('authToken')||localStorage.getItem('token')||localStorage.getItem('jwt')||localStorage.getItem('auth_token');if(!token){throw new Error('No authentication token found. Please login to your Recipe Genius app first.')}return token}catch(error){throw new Error('Authentication token not found. Please login to your Recipe Genius app.')}}function createOverlay(){const existingOverlay=document.getElementById('recipe-importer-overlay');if(existingOverlay){existingOverlay.remove()}const styleEl=document.createElement('style');styleEl.textContent=overlayStyles;document.head.appendChild(styleEl);const overlay=document.createElement('div');overlay.id='recipe-importer-overlay';overlay.innerHTML=`<div id=\"recipe-importer-modal\"><button id=\"recipe-importer-close\">&times;</button><h2 class=\"recipe-importer-title\">üç≥ Thermomix Recipe Genius</h2><div id=\"recipe-importer-content\"><div class=\"recipe-importer-status status-loading\"><span class=\"loading-spinner\"></span>Analyzing page for recipes...</div></div></div>`;document.body.appendChild(overlay);document.getElementById('recipe-importer-close').onclick=function(){overlay.remove()};overlay.onclick=function(e){if(e.target===overlay){overlay.remove()}};return overlay}function updateOverlay(content){const contentEl=document.getElementById('recipe-importer-content');if(contentEl){contentEl.innerHTML=content}}function showSuccess(recipeData){const recipe=recipeData.recipe;const content=`<div class=\"recipe-importer-status status-success\">‚úÖ Recipe found and extracted successfully!</div><div class=\"recipe-preview\"><h3>${recipe.title}</h3><p><strong>Ingredients:</strong> ${recipe.ingredients.length} items</p><p><strong>Instructions:</strong> ${recipe.instructions.length} steps</p><p><strong>Prep Time:</strong> ${recipe.prepTime} minutes</p><p><strong>Servings:</strong> ${recipe.servings}</p>${recipe.description?`<p><strong>Description:</strong> ${recipe.description}</p>`:''}</div><div class=\"recipe-importer-buttons\"><button class=\"btn btn-primary\" onclick=\"window.open('${API_BASE.replace('3003','8081')}','_blank')\">Open Recipe Genius App</button><button class=\"btn btn-secondary\" onclick=\"document.getElementById('recipe-importer-overlay').remove()\">Close</button></div>`;updateOverlay(content)}function showError(message){const content=`<div class=\"recipe-importer-status status-error\">‚ùå ${message}</div><div class=\"recipe-importer-buttons\"><button class=\"btn btn-secondary\" onclick=\"document.getElementById('recipe-importer-overlay').remove()\">Close</button></div>`;updateOverlay(content)}async function extractAndSendRecipe(){try{const overlay=createOverlay();let authToken;try{authToken=getAuthToken()}catch(error){showError(error.message);return}const html=document.documentElement.outerHTML;const url=window.location.href;const title=document.title;console.log('üìñ Bookmarklet: Sending recipe data to API');console.log('üìç URL:',url);console.log('üìÑ Title:',title);console.log('üìè HTML length:',html.length);const response=await fetch(API_ENDPOINT,{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${authToken}`},body:JSON.stringify({html:html,url:url,title:title})});const data=await response.json();if(response.ok&&data.success){console.log('‚úÖ Recipe extracted successfully:',data);showSuccess(data)}else{console.error('‚ùå API Error:',data);showError(data.error||'Failed to extract recipe from this page')}}catch(error){console.error('üí• Bookmarklet Error:',error);showError('Network error: Could not connect to Recipe Genius app. Make sure the app is running.')}}extractAndSendRecipe()})();" class="bookmarklet-link">üç≥ Recipe Genius Importer</a>
            <p style="margin-top: 15px; color: #666; font-size: 14px;">
                Haz clic derecho en el bot√≥n ‚Üí "Agregar a marcadores" o arrastra a la barra de marcadores
            </p>
        </div>

        <div class="instructions">
            <h2>üìã Instrucciones de Uso:</h2>

            <div class="step">
                <strong>Paso 1:</strong> Aseg√∫rate de que tu app Recipe Genius est√© ejecut√°ndose en <code>http://localhost:8081</code> y el backend en <code>http://localhost:3003</code>
            </div>

            <div class="step">
                <strong>Paso 2:</strong> Inicia sesi√≥n en tu app Recipe Genius para obtener el token de autenticaci√≥n
            </div>

            <div class="step">
                <strong>Paso 3:</strong> Arrastra el bot√≥n verde de arriba a tu barra de marcadores del navegador
            </div>

            <div class="step">
                <strong>Paso 4:</strong> Navega a cualquier p√°gina con recetas (Cookidoo, blogs de cocina, etc.)
            </div>

            <div class="step">
                <strong>Paso 5:</strong> Haz click en el bookmarklet "üç≥ Recipe Genius Importer" en tu barra de marcadores
            </div>

            <div class="step">
                <strong>Paso 6:</strong> ¬°La receta se extraer√° autom√°ticamente y se mostrar√° un preview!
            </div>
        </div>

        <div class="features">
            <div class="feature">
                <h3>üåê Universal</h3>
                <p>Funciona en cualquier p√°gina web con recetas, no solo Cookidoo</p>
            </div>

            <div class="feature">
                <h3>üîê Con Login</h3>
                <p>Accede a contenido autenticado como recetas privadas de Cookidoo</p>
            </div>

            <div class="feature">
                <h3>ü§ñ IA Inteligente</h3>
                <p>Usa OpenAI para extraer ingredientes e instrucciones autom√°ticamente</p>
            </div>

            <div class="feature">
                <h3>‚ö° R√°pido</h3>
                <p>Extracci√≥n instant√°nea desde el DOM, sin necesidad de hacer requests HTTP</p>
            </div>
        </div>

        <div class="warning">
            <strong>‚ö†Ô∏è Importante:</strong>
            <ul>
                <li>Debes estar logueado en tu app Recipe Genius antes de usar el bookmarklet</li>
                <li>El backend debe estar ejecut√°ndose en localhost:3003</li>
                <li>Funciona mejor en Chrome, Firefox y Edge</li>
            </ul>
        </div>

        <details>
            <summary><strong>üîß Para desarrolladores: C√≥digo fuente del bookmarklet</strong></summary>
            <div class="code" id="bookmarklet-code">
                <!-- El c√≥digo se insertar√° aqu√≠ con JavaScript -->
            </div>
        </details>
    </div>

    <script>
        // Insert the readable bookmarklet code
        document.getElementById('bookmarklet-code').textContent = `(function() {
    'use strict';

    const API_BASE = 'http://localhost:3003';
    const API_ENDPOINT = \`\${API_BASE}/api/import-html\`;

    // Function to get auth token from localStorage
    function getAuthToken() {
        const token = localStorage.getItem('authToken') ||
                     localStorage.getItem('token') ||
                     localStorage.getItem('jwt') ||
                     localStorage.getItem('auth_token');

        if (!token) {
            throw new Error('No authentication token found. Please login first.');
        }
        return token;
    }

    // Main extraction function
    async function extractAndSendRecipe() {
        try {
            const authToken = getAuthToken();
            const html = document.documentElement.outerHTML;
            const url = window.location.href;
            const title = document.title;

            const response = await fetch(API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': \`Bearer \${authToken}\`
                },
                body: JSON.stringify({ html, url, title })
            });

            const data = await response.json();

            if (response.ok && data.success) {
                // Show success overlay with recipe preview
                showSuccess(data);
            } else {
                showError(data.error || 'Failed to extract recipe');
            }
        } catch (error) {
            showError('Could not connect to Recipe Genius app');
        }
    }

    extractAndSendRecipe();
})();`;
    </script>
</body>
</html>